<div class="w-full h-full relative">
    <!-- Toast Messages -->
    <p-toast></p-toast>

    <div
        id="map"
        class="w-full rounded absolute"
        style="height: 100vh; position: relative; z-index: 1"
    ></div>

    <p-card
        class="absolute top-0 right-0 m-4 grid p-fluid"
        header="Legend"
        [style.z-index]="999"
    >
        <div>
            <div class="flex flex-column">
                <div class="flex gap-2 align-items-center">
                    <div
                        style="
                            border: 1px solid #008000;
                            height: 1rem;
                            width: 1rem;
                        "
                    ></div>
                    <p>Cleaned Buildings</p>
                </div>
                <div class="flex gap-2 align-items-center">
                    <div
                        style="
                            border: 1px solid #90ee90;
                            height: 1rem;
                            width: 1rem;
                        "
                    ></div>
                    <p>Cleaned Buildings (with Photos)</p>
                </div>
                <div class="flex gap-2 align-items-center">
                    <div
                        style="border: 1px solid red; height: 1rem; width: 1rem"
                    ></div>
                    <p>Uncleaned Buildings</p>
                </div>
                <div class="flex gap-2 align-items-center">
                    <div
                        style="
                            border: 1px solid #ffa500;
                            height: 1rem;
                            width: 1rem;
                        "
                    ></div>
                    <p>Uncleaned Buildings (with Photos)</p>
                </div>
                <div *ngIf="isFileLoaded" class="flex gap-2 align-items-center">
                    <div
                        style="
                            background: #00ffff;
                            border-radius: 50%;
                            height: 0.8rem;
                            width: 0.8rem;
                        "
                    ></div>
                    <p>Survey Points Epicollect</p>
                </div>
                <div *ngIf="isCSVLoaded" class="flex gap-2 align-items-center">
                    <div
                        style="
                            background: #ff7800;
                            border-radius: 50%;
                            height: 0.8rem;
                            width: 0.8rem;
                        "
                    ></div>
                    <p>CSV Building Survey Data</p>
                </div>
            </div>
        </div>
    </p-card>

    <p-card
        class="absolute top-0 left-0 m-4 grid p-fluid"
        header="Select Zone"
        [style.z-index]="999"
    >
        <p>Select Dzongkhag</p>
        <p-dropdown
            [options]="dzongkhags"
            [(ngModel)]="selectedDzongkhag"
            optionLabel="name"
            [showClear]="false"
            placeholder="Select a Dzongkhag"
            [filter]="true"
            optionLabel="name"
            filterBy="name"
            (ngModelChange)="onDzongkahgChange($event)"
        >
            <ng-template pTemplate="selectedItem">
                <div
                    class="flex align-items-center gap-2 w-full"
                    *ngIf="selectedDzongkhag"
                >
                    <p>{{ selectedDzongkhag.name }}</p>
                </div>
            </ng-template>
            <ng-template let-dzongkhag pTemplate="item">
                <div class="flex align-items-center gap-2">
                    <div>{{ dzongkhag.name }}</div>
                </div>
            </ng-template>
        </p-dropdown>

        <p-divider type="dotted"></p-divider>

        <p-button
            *ngIf="selectedDzongkhag?.id"
            label="Load Buildings"
            pRipple
            (onClick)="loadPlotsAndBuildings()"
        ></p-button>

        <p-divider type="dotted"></p-divider>

        <!-- Survey Data File Upload Section -->
        <div class="survey-data-section">
            <p><strong>Load Excel Survey Data</strong></p>

            <p-fileUpload
                mode="basic"
                name="surveyFile"
                accept=".json"
                maxFileSize="1000000000"
                chooseLabel="Upload JSON File"
                (onSelect)="onFileSelect($event)"
                [auto]="true"
                chooseIcon="pi pi-upload"
            ></p-fileUpload>

            <div *ngIf="isFileLoaded" class="mt-2 flex gap-2 flex-column">
                <small class="text-green-500">
                    <i class="pi pi-check-circle"></i>
                    {{ loadedSurveyData.length }} survey points loaded
                </small>
                <div class="flex gap-2">
                    <p-button
                        label="Clear Data"
                        severity="secondary"
                        size="small"
                        icon="pi pi-times"
                        (onClick)="clearSurveyData()"
                    ></p-button>
                    <p-button
                        label="Export GeoJSON"
                        severity="secondary"
                        size="small"
                        icon="pi pi-download"
                        (onClick)="exportCurrentSurveyData()"
                    ></p-button>
                </div>
            </div>
        </div>

        <!-- CSV Building Survey Data Upload Section -->
        <div class="csv-data-section mt-3">
            <p><strong>Load Building Survey CSV</strong></p>

            <p-fileUpload
                mode="basic"
                name="csvFile"
                accept=".csv"
                maxFileSize="1000000000"
                chooseLabel="Upload CSV File"
                (onSelect)="onCSVFileSelect($event)"
                [auto]="true"
                chooseIcon="pi pi-upload"
            ></p-fileUpload>

            <div *ngIf="isCSVLoaded" class="mt-2 flex gap-2 flex-column">
                <small class="text-green-500">
                    <i class="pi pi-check-circle"></i>
                    {{ loadedCSVData.length }} building survey points loaded
                </small>
                <div class="flex gap-2">
                    <p-button
                        label="Clear CSV Data"
                        severity="secondary"
                        size="small"
                        icon="pi pi-times"
                        (onClick)="clearCSVData()"
                    ></p-button>
                    <p-button
                        label="Export CSV GeoJSON"
                        severity="secondary"
                        size="small"
                        icon="pi pi-download"
                        (onClick)="exportCSVAsGeoJSON()"
                    ></p-button>
                </div>
            </div>
        </div>

        <div class="mt-4 flex gap-2 flex-column">
            <p><strong>Export Building Data</strong></p>
            <div class="flex gap-2 flex-column">
                <p-button
                    [outlined]="true"
                    severity="success"
                    size="small"
                    label="Download Cleaned Building Footprint"
                    icon="pi pi-download"
                    (onClick)="downloadCleanedBuildingFootprintGeoJSON()"
                    [disabled]="
                        !cleanedBuildingsLayer || cleanedBuildings.length === 0
                    "
                ></p-button>
                <p-button
                    [outlined]="true"
                    severity="danger"
                    size="small"
                    label="Download Uncleaned Building Footprint"
                    icon="pi pi-download"
                    (onClick)="downloadUncleanedBuildingFootprintGeoJSON()"
                    [disabled]="
                        !uncleanedBuildingsLayer ||
                        uncleanedBuildings.length === 0
                    "
                ></p-button>
            </div>
        </div>

        <p-divider type="dotted"></p-divider>

        <div class="mt-4 flex gap-2 flex-column">
            <p><strong>Locate Features</strong></p>

            <!-- Locate Survey Point by UUID -->
            <div class="flex flex-column gap-2">
                <label for="surveyUuid" class="text-sm font-medium"
                    >Survey UUID</label
                >
                <div class="flex gap-2">
                    <input
                        id="surveyUuid"
                        class="p-inputtext p-component flex-1"
                        [(ngModel)]="locateUuid"
                        placeholder="Enter survey UUID"
                    />
                    <p-button
                        label="Locate"
                        size="small"
                        icon="pi pi-search"
                        (onClick)="locateSurveyByUuid()"
                        [disabled]="!locateUuid || !isFileLoaded"
                    ></p-button>
                </div>
            </div>

            <!-- Locate Building by ID -->
            <div class="flex flex-column gap-2">
                <label for="buildingId" class="text-sm font-medium"
                    >Building ID</label
                >
                <div class="flex gap-2">
                    <input
                        id="buildingId"
                        class="p-inputtext p-component flex-1"
                        [(ngModel)]="locateBuildingId"
                        placeholder="Enter building ID"
                        type="number"
                    />
                    <p-button
                        label="Locate"
                        size="small"
                        icon="pi pi-search"
                        (onClick)="locateBuildingById()"
                        [disabled]="
                            !locateBuildingId ||
                            (!cleanedBuildingsLayer && !uncleanedBuildingsLayer)
                        "
                    ></p-button>
                </div>
            </div>
        </div>
    </p-card>
</div>
